name: akari-bootstrap
on:
  push:
    paths:
      - ".github/workflows/akari-bootstrap.yml"
      - "bootstrap-assets/render_autodeploy_working.json"
  workflow_dispatch: {}

jobs:
  init:
    runs-on: ubuntu-latest
    env:
      N8N_KEY:           ${{ secrets.N8N_PERSONAL_API_KEY }}
      RENDER_SERVICE:    ${{ secrets.RENDER_SERVICE }}
      RENDER_API_TOKEN:  ${{ secrets.RENDER_API_TOKEN }}
      N8N_DOMAIN:        n8n-xl04.onrender.com    # ←あなたの n8n ドメイン

    steps:
      - uses: actions/checkout@v4

      # 1) Render 環境変数に n8n API KEY を注入
      - name: Inject n8n key into Render
        run: |
          curl --fail -s -X PUT "https://api.render.com/v1/services/${RENDER_SERVICE}/env-vars" \
               -H "Authorization: Bearer ${RENDER_API_TOKEN}" \
               -H "Content-Type: application/json" \
               -d '[{"key":"N8N_PERSONAL_API_KEY","value":"'"${N8N_KEY}"'","serviceId":"'"${RENDER_SERVICE}"'"}]'

      # 2) ブートストラップ用ワークフロー JSON をダウンロード
      - name: Download workflow JSON
        run: |
          curl --fail -sL \
            https://raw.githubusercontent.com/AInoAKARI/bootstrap-assets/main/render_autodeploy_working.json \
            -o /tmp/wf.json

      # 3) n8n にインポート
      - name: Import into n8n
        run: |
          curl --fail -s -X POST "https://${N8N_DOMAIN}/rest/workflows" \
               -H "X-N8N-API-KEY: ${N8N_KEY}" \
               -H "Content-Type: application/json" \
               --data-binary @/tmp/wf.json
